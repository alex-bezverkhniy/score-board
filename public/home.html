<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/spectre.min.css">
    <link rel="stylesheet" href="/css/score-badge.css">
    <script type="module" src="/js/app.js"></script>
    <title>Eva's score</title>
    <style>
        main {
            margin-top: 1rem;
        }
        footer {
            margin-top: 3rem;
            color: #ccc;
        }
        .card-image {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .navbar-section {
            padding: 1em;
        }
    </style>
</head>

<body>
    <header class="navbar">
        <section class="navbar-section">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-award"
            viewBox="0 0 16 16">
                <path
                    d="M9.669.864 8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68L9.669.864zm1.196 1.193.684 1.365 1.086 1.072L12.387 6l.248 1.506-1.086 1.072-.684 1.365-1.51.229L8 10.874l-1.355-.702-1.51-.229-.684-1.365-1.086-1.072L3.614 6l-.25-1.506 1.087-1.072.684-1.365 1.51-.229L8 1.126l1.356.702 1.509.229z" />
                <path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1 4 11.794z" />
            </svg>
            <a href="..." class="navbar-brand mr-2">Eva's score</a>
        </section>
    </header>
    <main>
        <div class="container">
            <div class="columns">
                <div class="column col-4 col-md-10 col-xl-8 col-mx-auto" id="app">
                </div>
            </div>
        </div>
        
    </main>
    <footer>
        <div class="columns">
            <div class="column col-4 col-md-10 col-xl-8 col-mx-auto">
                Eva's Score 
            </div>
        </div>
    </footer>
<script type="module">
import { h, Component, render, createContext } from 'https://unpkg.com/preact@latest?module';
import { useState, useMemo, useEffect, useContext } from 'https://unpkg.com/preact@latest/hooks/dist/hooks.module.js?module';
import htm from 'https://unpkg.com/htm?module'
// import { h, Component, render } from '/js/preact.module.js';
// import { useState, useEffect } from 'https://unpkg.com/preact@latest/hooks/dist/hooks.module.js?module';
// import htm from '/js/htm.module.js';
  
// Initialize htm with Preact
const html = htm.bind(h);
const ScoreDataContext = createContext({});
const baseUrl = '/api/score'

function StatusBage(props) {
  var todaysScoreSign = props.todaysScore > 0 ? "+":"-";
  return html`
<div class="badge_container">
    <div class="total_badge">
        <div class="badge__label" id="totalPoints">
            ${todaysScoreSign}${props.todaysScore}
        </div>
        <div class="badge__label_sm" id="totalPoints">
            total: ${props.totalScore}
        </div>
    </div>
</div>`;
}

function TasksLog (props) {        

    return html`
<table class="table">
    <thead>
        <tr>
            <th>task</th>
            <th>points</th>
            <th>date</th>
        </tr>
    </thead>
    <tbody>
        ${props.tasks.map((task, k) => html`
        <tr>
            <td>${task.task}</td>
            <td>
                <span class="chip">${task.points}</span>
            </td>
            <td>${task.added_at.replace("T", " ").replace("-06:00", "")}</td>
        </tr>
        `)}
    </tbody>
</table>`    
}

function FilterForm(props) {
    const [value, setValue] = useState(new Date(new Date().toString().split('GMT')[0]+' UTC').toISOString().split('.')[0])

    const { scoreData, fetchScoreData } = useContext(ScoreDataContext);

    const onSubmit = (e) => {
        // var url = localStorage.getItem('apiURL') ? localStorage.getItem('apiURL') : "/api/score"; //"/api/score"
        console.log('filter submit', value);
        const unixTime = Math.floor(Date.parse(value) / 1000)
        fetchScoreData(`${baseUrl}/${unixTime}`);
    }
    const onInput = (e) => {
        setValue(e.target.value)
    }

    return html`
    <div class="input-group">
    <span class="input-group-addon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
            <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z"/>
        </svg>                                
    </span>
    <input type="datetime-local" value=${value} class="form-input" onInput=${onInput}/>
    <button onClick=${onSubmit} class="btn btn-primary input-group-btn">Filter</button>
</div>`
}

function AddTaskForm(props) {
    const onSubmit = e => {
        alert("Submitted a task");
        e.preventDefault();
    
    }

    return html`
<div class="input-group">
    <span class="input-group-addon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
            class="bi bi-journal-check" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M10.854 6.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 8.793l2.646-2.647a.5.5 0 0 1 .708 0z" />
            <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z" />
            <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z" />
        </svg>
    </span>
    <input type="text" class="form-input" placeholder="..."/>
    <button onClick=${onSubmit}  class="btn btn-primary input-group-btn">Add</button>
</div>`
}

// App
function App() {
	const [scoreData, setScoreData] = useState({});

    const [tasksData, setTasksData] = useState({
        data: []        
    });    

    function fetchScoreData(url) {
        console.log("fetchScoreData", url);
        url = (url == null || url == undefined || url == "") ? scoreData.url : url
        url = (url == null || url == undefined || url == "") ? baseUrl : url

        fetch(url)
        .then((data) => {            
            return data.json()
        })
        .then((json) => {            
            console.log(json);
            const newScoreData = {
                tasksData : json,
                url: url
            }
            setScoreData(newScoreData);
            setTasksData(json);
        });
    }

	useEffect(() => {
        const url = localStorage.getItem('apiURL') ? localStorage.getItem('apiURL') : "/api/score"; //"/api/score"		
        fetchScoreData();
	}, []);

	const scoreDataResource = useMemo(() => {
		return { scoreData, fetchScoreData };
	}, [scoreData]);

	return html`
<${ScoreDataContext.Provider} value=${scoreDataResource}>
<div class="card">
    <div class="card-image">  
        <${StatusBage} todaysScore=${tasksData.total_starts_at} totalScore=${tasksData.total_points} />
    </div>
    <div class="card-header">
        <${FilterForm} />
    </div>
    <div class="card-body">
        <$${TasksLog} tasks=${tasksData.data}/>
    </div>
    <div class="card-footer">
        <${AddTaskForm} />
    </div>       
</div>
</ScoreDataContext.Provider>
`;
}
render(h(App), document.getElementById('app'));
</script>
</body>

</html>