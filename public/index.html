<!-- See https://github.com/gorilla/websocket/blob/master/examples/chat/home.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chat Example</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    
    <script src="/js/jquery-min.js"></script>
    <script src="/js/underscore-min.js" ></script>

    <script src="/js/backbone-min.js"></script>

    <script type="text/javascript">     
        window.onload = function () {

            var conn;
            var msg = document.getElementById("msg");
            var log = document.getElementById("log");
            var totalPoints = document.getElementById("totalPoints")

            function appendLog(item) {
                var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;                
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            }

            function printScore(score) {                
                console.log(score);             
                totalPoints.innerText = score.total_points           
                var item = createListItem(score)
                // item.innerText = messages[i];
                appendLog(item);
            }

            function createListItem(score) {
                var li = document.createElement('li')
                li.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center")

                var sign = score.points >0 ? "+": ""
                var color = sign == "+" ? "bg-success" : "bg-danger"
                var badge = document.createElement('span')
                badge.classList.add("badge",color,"rounded-pill")
                
                badge.innerText =  sign+" "+score.points

                var task = document.createElement('span')
                task.classList.add("text-truncate")
                task.innerText =  score.task

                li.appendChild(badge)
                li.appendChild(task)

                return li
            }

            // document.getElementById("form").onsubmit = function () {
            //     if (!conn) {
            //         return false;
            //     }
            //     if (!msg.value) {
            //         return false;
            //     }
            //     conn.send(msg.value);
            //     msg.value = "";
            //     return false;
            // };
            

            // if (window["WebSocket"]) {
            //     conn = new WebSocket("ws://" + document.location.host + "/ws");
            //     // conn.onopen = function(evt) {
            //     //     totalPoints.innerText = "0"
            //     // }
            //     conn.onclose = function (evt) {
            //         var item = document.createElement("div");
            //         item.innerHTML = "<b>Connection closed.</b>";
            //         appendLog(item);
            //     };
            //     conn.onmessage = function (evt) {
            //         console.log("GOT event");
            //         // for (var i = 0; i < messages.length; i++) {
            //             var scores = JSON.parse(evt.data)
            //             if (scores != undefined && scores.length > 0) { 
            //                 log.innerHTML = "";
            //                 var totalPts = 0;
            //                 for (var i = 0; i < scores.length; i++) {                            
            //                     printScore(scores[i]);
            //                     totalPts += scores[i].points
            //                 }
            //                 totalPoints.innerText = totalPts;
            //             } 
            //         // /}
            //     };
            // // } else {
            //     var item = document.createElement("div");
            //     item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
            //     appendLog(item);
            // }
        };
    </script>
    <style type="text/css">
        .badge_container {
            align-items: center;
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: center;
        }
@-webkit-keyframes introduceBadge {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}

@keyframes introduceBadge {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}
@-webkit-keyframes pulseBadge {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}
@keyframes pulseBadge {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}
@-webkit-keyframes pulseBadge2 {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}
@keyframes pulseBadge2 {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}
.total_badge {
  -webkit-animation: introduceBadge 1s linear 0s 1 both;
          animation: introduceBadge 1s linear 0s 1 both;
  /* background: rgba(0, 113, 246, 0.2); */
  background-color: #d5def5;
  border-radius: 50%;
  height: 236px;
  perspective: 600px;
  position: relative;
  width: 236px;
}
.total_badge:before, .total_badge:after {
  -webkit-animation: pulseBadge 3s cubic-bezier(0.86, 0, 0.07, 1) 0s infinite both;
          animation: pulseBadge 3s cubic-bezier(0.86, 0, 0.07, 1) 0s infinite both;
  border: 2px dashed #6643b5;
  border-radius: inherit;
  bottom: -16px;
  content: "";
  left: -16px;
  opacity: 0.2;
  position: absolute;
  right: -16px;
  top: -16px;
}
.total_badge:after {
  -webkit-animation-name: pulseBadge2;
          animation-name: pulseBadge2;
  bottom: -32px;
  left: -32px;
  opacity: 0.1;
  right: -32px;
  top: -32px;
}

@-webkit-keyframes introduceLabel {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.4) rotateY(-1800deg);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1) rotateY(20deg);
  }
}

@keyframes introduceLabel {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.4) rotateY(-1800deg);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1) rotateY(20deg);
  }
}
@-webkit-keyframes rotateLabel {
  0% {
    transform: translate(-50%, -50%) rotateY(20deg);
  }
  50% {
    transform: translate(-50%, -50%) rotateY(-20deg);
  }
  100% {
    transform: translate(-50%, -50%) rotateY(20deg);
  }
}
@keyframes rotateLabel {
  0% {
    transform: translate(-50%, -50%) rotateY(20deg);
  }
  50% {
    transform: translate(-50%, -50%) rotateY(-20deg);
  }
  100% {
    transform: translate(-50%, -50%) rotateY(20deg);
  }
}
.badge__label {
  -webkit-animation: introduceLabel 2s cubic-bezier(0.19, 1, 0.22, 1) 1s 1 both, rotateLabel 5s linear 3s infinite;
          animation: introduceLabel 2s cubic-bezier(0.19, 1, 0.22, 1) 1s 1 both, rotateLabel 5s linear 3s infinite;
  color: #6643b5;
  font: 900 88px/1 -apple-system, BlinkMacSystemFont;
  left: 50%;
  font-size: 4em;
  position: absolute;
  text-align: center;
  text-shadow: 0px 4px 8px rgba(0, 113, 246, 0.2);
  top: 50%;
  transform: translate(-50%, -50%);
}
        
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-award"
                    viewBox="0 0 16 16">
                    <path
                        d="M9.669.864 8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68L9.669.864zm1.196 1.193.684 1.365 1.086 1.072L12.387 6l.248 1.506-1.086 1.072-.684 1.365-1.51.229L8 10.874l-1.355-.702-1.51-.229-.684-1.365-1.086-1.072L3.614 6l-.25-1.506 1.087-1.072.684-1.365 1.51-.229L8 1.126l1.356.702 1.509.229z" />
                    <path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1 4 11.794z" />
                </svg>
                Eva's score
            </a>
        </div>
    </nav>
    <p></p>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <div class="card mb-6" id='app'>
                  <!-- {{ -->
                    <!-- }} -->
                </div>
            </div>
        </div>
    </div>

<script id='tpl_list' type='text/template'>    
      <div class="badge_container" >
        <div class="total_badge">
          <div class="badge__label" id="totalPoints">
            +0
          </div>
        </div>
      </div>
      <div class="card-body">
          <h5 class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-journal-check" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M10.854 6.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 8.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                  <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/>
                  <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/>
              </svg>
              Task's log:
          </h5>
          
          <p class="card-text">
          <div class="overflow-auto" style="max-height: 50rem;">
            <div class="input-group mb-3">                        
              <input id="startDate" 
              type="datetime-local" 
              pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}"
              class="form-control">
              <button class="btn btn-outline-secondary" type="submit" id="filter">Filter</button>
          </div>    
  
            <ul class="list-group"></ul>

            <p></p>
            <div class="input-group mb-3">                        
                <input type="text" id="msg" class="form-control" placeholder="New Task"
                    aria-label="new task" aria-describedby="filter">
                <button class="btn btn-outline-secondary" id="add">Add</button>
            </div>

          </div>

          </p>                        
      </div>
</script>
    
<script id='tpl_list_item' type='text/template'>
        <span>
            <span class="badge bg-success rounded-pill"><%= points %></span>  
            <span class="text-truncate"><%= task %></span>
        </span>
</script>

<script>
(function($) {
var conn;
var baseURL = '/api/score';
var totalScore = 0;

// Model

var Item = Backbone.Model.extend({
  defaults: {
    points: 10,
    task: 'world'
  }
});


// Collection

var List = Backbone.Collection.extend({
    url: baseURL,
    parse: function(data) {
        console.log("got scores", data);
        var totalScoreEl = $('#totalScore');
        var ts = 0;
        data.forEach(s => {
          ts = ts + s.points;
        });
        totalScoreEl.val(ts > 0 ? '+'+ts : '-'+ts);
        return data;
    },
    model: Item
});


// Views

var ItemView = Backbone.View.extend({
  tagName: 'li',
  
  template: _.template($('#tpl_list_item').html()),

  events: {
  },

  initialize: function() {
    _.bindAll(this, 'render', 'unrender');
    this.model.on('change', this.render);
    this.model.on('remove', this.unrender);
  },

  render: function() {
    this.el.classList.add("list-group-item","d-flex","justify-content-between","align-items-center")
    this.$el.html(this.template(this.model.attributes));
    
    return this;
  },

  unrender: function() {
    this.$el.remove();
  },

  remove: function() {
    this.model.destroy();
  }
});


var ListView = Backbone.View.extend({
  el: $('#app'),
  
  template: _.template($('#tpl_list').html()),

  events: {
    'click #filter': 'filter',
    'click #add': 'addItem'
  },

  initialize: function() {
    _.bindAll(this, 'render', 'addItem', 'filter', 'appendItem');
    this.collection = new List();
    // this.collection.fetch()
    this.collection.on('add', this.appendItem);
    this.startDate = new Date();
    this.totalScore = 0;
    this.startDate.setHours(0,0,0,0);
    this.render();
  },

  render: function() {
    this.$el.append(this.template());
    var startDateEl = $('#startDate');
    var sd = new Date(this.startDate.toString().split('GMT')[0]+' UTC').toISOString().split('.')[0] ;
    console.log("set current datetime", sd);
    startDateEl.val(sd);
    return this;
  },

  addItem: function() {        
    if (conn) {
        var msg = $('#msg');
        conn.send(msg.val());
        msg.val("");
    }
  },

  filter: function() {    
    var startDateEl = $('#startDate');
    var startDate = startDateEl.val();
    var unixTime = Math.floor(Date.parse(startDate) / 1000)
    console.log('startDate', unixTime);
    this.collection.url = baseURL+'/'+unixTime
    this.collection.fetch();
  },

  appendItem: function(item) {
    var itemView = new ItemView({ model: item });
    $('ul', this.el).append(itemView.render().el);
  }
});

var listView = new ListView();

if (window["WebSocket"]) {
        conn = new WebSocket("ws://" + document.location.host + "/ws");
        conn.onopen = function(evt) {
            // totalPoints.innerText = "0"
            console.log("OPEN");
        }
        conn.onclose = function (evt) {
            // var item = document.createElement("div");
            // item.innerHTML = "<b>Connection closed.</b>";
            // appendLog(item);
            console.log("CLOSE");
        };
        conn.onmessage = function (evt) {
            console.log("GOT event");
            listView.collection.fetch();
            // // for (var i = 0; i < messages.length; i++) {
            //     var scores = JSON.parse(evt.data)
            //     if (scores != undefined && scores.length > 0) { 
            //         log.innerHTML = "";
            //         var totalPts = 0;
            //         for (var i = 0; i < scores.length; i++) {                            
            //             printScore(scores[i]);
            //             totalPts += scores[i].points
            //         }
            //         totalPoints.innerText = totalPts;
            //     } 
            // // /}
        };
    }

})(jQuery);

</script>

</body>

</html>