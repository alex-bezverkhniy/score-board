<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/spectre.min.css">
    <link rel="stylesheet" href="/css/score-badge.css">
    <link rel="stylesheet" href="/css/icons.min.css">
    <script type="module" src="/js/app.js"></script>
    <title>Eva's score</title>
    <style>
        main {
            /* margin-top: 1rem; */
        }
        footer {
            /* margin-top: 1rem; */
            color: #ccc;
        }
        td {
          font-size: 0.7rem;
        }
        .card-image {
            margin-top: 1rem;
            margin-bottom: 2rem;
        }
        .navbar-section {
            padding: 1em;
        }
        .with-v-scroll {
          max-height: 10rem;
          overflow: auto;
        }
        .delete-btn {

        }
    </style>
</head>

<body>
    <header class="navbar">
        <section class="navbar-section">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-award"
            viewBox="0 0 16 16">
                <path
                    d="M9.669.864 8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68L9.669.864zm1.196 1.193.684 1.365 1.086 1.072L12.387 6l.248 1.506-1.086 1.072-.684 1.365-1.51.229L8 10.874l-1.355-.702-1.51-.229-.684-1.365-1.086-1.072L3.614 6l-.25-1.506 1.087-1.072.684-1.365 1.51-.229L8 1.126l1.356.702 1.509.229z" />
                <path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1 4 11.794z" />
            </svg>
            <a href="..." class="navbar-brand mr-2">Eva's score</a>
        </section>
    </header>
    <main>
        <div class="container">
            <div class="columns">
                <div class="column col-4 col-md-10 col-xl-8 col-mx-auto" id="app">
                </div>
            </div>
        </div>
        
    </main>
    <footer>
        <div class="columns">
            <div class="column col-4 col-md-10 col-xl-8 col-mx-auto">
                Eva's Score 
            </div>
        </div>
    </footer>
<script type="module">
import { h, Component, render, createContext } from 'https://unpkg.com/preact@latest?module';
import { useState, useMemo, useEffect, useContext } from 'https://unpkg.com/preact@latest/hooks/dist/hooks.module.js?module';
import htm from 'https://unpkg.com/htm?module'
// import { h, Component, render } from '/js/preact.module.js';
// import { useState, useEffect } from 'https://unpkg.com/preact@latest/hooks/dist/hooks.module.js?module';
// import htm from '/js/htm.module.js';
  
// Initialize htm with Preact
const html = htm.bind(h);
const ScoreDataContext = createContext({});
const baseUrl = '/api/score'

function toUnixTimestamp(str) {
  return Math.floor(Date.parse(str) / 1000)
}

function StatusBage(props) {
  var todaysScoreSign = props.todaysScore > 0 ? "+":"-";
  return html`
<div class="badge_container">
    <div class="total_badge">
        <div class="badge__label" id="totalPoints">
            ${todaysScoreSign}${props.todaysScore}
        </div>
        <div class="badge__label_sm" id="totalPoints">
            total: ${props.totalScore}
        </div>
    </div>
</div>`;
}

function DeleteDlg(props) {
    return html`
<div class="modal active" id="modal-id">
  <a href="#close" class="modal-overlay" aria-label="Close"></a>
  <div class="modal-container">
    <div class="modal-header">
      <a href="#close" class="btn btn-clear float-right" aria-label="Close"></a>
      <div class="modal-title h5">Modal title</div>
    </div>
    <div class="modal-body">
      <div class="content">
        <!-- content here -->
      </div>
    </div>
    <div class="modal-footer">
      ...
    </div>
  </div>
</div>
    `
}

function TasksLog (props) {        
    const { deleteScoreData} = useContext(ScoreDataContext);

  const onDelete = (e) => {    
    const k = e.target.dataset.key
    console.log('delete', k);
    deleteScoreData(k);
    e.preventDefault()
  }


  return html`
<div class="panel with-v-scroll">
<table class="table">
    <thead>
        <tr>
            <th>points</th>
            <th>task <span class="chip" title="tasks displayed">${props.tasks.length}</span></th>
            <th>date</th>
            <th>
                <i class="icon icon-close"></i>
            </th>
        </tr>
    </thead>
    <tbody>
        ${props.tasks.map((task, k) => html`
        <tr>
            <td>
              <span class="chip">${task.points}</span>
            </td>
            <td>${task.task}</td>
            <td>${task.added_at.replace("T", " ").replace("-06:00", "")}</td>
            <td>
              <a href="#" data-key=${toUnixTimestamp(task.added_at)} class="btn-sm btn-action s-circle" onClick=${onDelete}>
                <i class="icon icon-close" data-key=${toUnixTimestamp(task.added_at)}></i>
              </a>
            </td>
        </tr>
        `)}
    </tbody>
</table>

</div>`    
}


function FilterForm(props) {    
    const currectDateTime = () => {
      const str = new Date(new Date().toString().split('GMT')[0]+' UTC').toISOString().split('.')[0];
      return str.substring(0, str.length - 3);
    }
    const [value, setValue] = useState(currectDateTime())

    const { scoreData, fetchScoreData} = useContext(ScoreDataContext);

    const onSubmit = (e) => {        
        // console.log('filter submit', value);
        const unixTime =toUnixTimestamp(value);
        fetchScoreData(`${baseUrl}/${unixTime}`);
        e.preventDefault();
    }
    const onInput = (e) => {
        setValue(e.target.value)
    }

    const onClean = (e) => {
      console.log('time', currectDateTime());
        setValue('');
        fetchScoreData(baseUrl);
        e.preventDefault();        
    }

    return html`
    <div class="input-group">
    <span class="input-group-addon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
            <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z"/>
        </svg>                                
    </span>
    <input type="datetime-local" value=${value} class="form-input" onInput=${onInput}/>
    <button onClick=${onClean} class="btn input-group-btn" title="Clean filter">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-backspace" viewBox="0 0 16 16">
        <path d="M5.83 5.146a.5.5 0 0 0 0 .708L7.975 8l-2.147 2.146a.5.5 0 0 0 .707.708l2.147-2.147 2.146 2.147a.5.5 0 0 0 .707-.708L9.39 8l2.146-2.146a.5.5 0 0 0-.707-.708L8.683 7.293 6.536 5.146a.5.5 0 0 0-.707 0z"/>
        <path d="M13.683 1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7.08a2 2 0 0 1-1.519-.698L.241 8.65a1 1 0 0 1 0-1.302L5.084 1.7A2 2 0 0 1 6.603 1h7.08zm-7.08 1a1 1 0 0 0-.76.35L1 8l4.844 5.65a1 1 0 0 0 .759.35h7.08a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1h-7.08z"/>
      </svg>
    </button>    
    <button onClick=${onSubmit} class="btn btn-primary input-group-btn" title="Search">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
      </svg>      
    </button>
</div>`
}

function AddTaskForm(props) {
    const [value, setValue] = useState("");
    const [hasError, setHasError] = useState(false);
    const { scoreData, fetchScoreData } = useContext(ScoreDataContext);

    const isInt = (value) => {
        return !isNaN(value) && 
                parseInt(Number(value)) == value && 
                !isNaN(parseInt(value, 10));
    }

    const onSubmit = e => {
        console.log("AddTask", value);

        if (value) {
            const i = value.indexOf(' ');            
            if ( !isInt(value.substring(0, i))) {
                setHasError(true);
                return;
            }
            const points = parseInt(value.substring(0, i));
            const task = value.substring(i+1);
            console.log(`add new points: "${points}", task: "${task}"`);
            if ( isNaN(points)) {
                setHasError(true)
            } else {
                const score = {
                    points: points,
                    task: task
                }
                fetch(baseUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(score)
                }).then((d) => {
                    fetchScoreData();
                    setHasError(false);
                    setValue('');
                })
            }

        } else {
            setHasError(true);
        }
        // fetch(baseUrl)

        fetchScoreData();
        e.preventDefault();
    }
    const onInput = (e) => {
        setValue(e.target.value)
    }
    const onClean = (e) => {
        setValue('');        
        e.preventDefault();        
    }

    return html`
<div class="form-group ${hasError ? "has-error" : ""}">
    <div class="input-group">
        <span class="input-group-addon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-journal-check" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10.854 6.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 8.793l2.646-2.647a.5.5 0 0 1 .708 0z" />
                <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z" />
                <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z" />
            </svg>
        </span>
        <input type="text" value=${value} onInput=${onInput}class="form-input" placeholder="..."/>    
        <button onClick=${onClean} class="btn input-group-btn" title="Clean task">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-backspace" viewBox="0 0 16 16">
            <path d="M5.83 5.146a.5.5 0 0 0 0 .708L7.975 8l-2.147 2.146a.5.5 0 0 0 .707.708l2.147-2.147 2.146 2.147a.5.5 0 0 0 .707-.708L9.39 8l2.146-2.146a.5.5 0 0 0-.707-.708L8.683 7.293 6.536 5.146a.5.5 0 0 0-.707 0z"/>
            <path d="M13.683 1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7.08a2 2 0 0 1-1.519-.698L.241 8.65a1 1 0 0 1 0-1.302L5.084 1.7A2 2 0 0 1 6.603 1h7.08zm-7.08 1a1 1 0 0 0-.76.35L1 8l4.844 5.65a1 1 0 0 0 .759.35h7.08a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1h-7.08z"/>
          </svg>
        </button>  
        <button onClick=${onSubmit}  class="btn btn-primary input-group-btn" title="Add new task">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
            <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
          </svg>
        </button>
    </div>
    <p class="form-input-hint ${!hasError ? "d-hide" : ""}">Please use next format: [points] [task description]</p>
</div>
`
}

// App
function App() {
	const [scoreData, setScoreData] = useState({});

    const [tasksData, setTasksData] = useState({
        data: []        
    });    

    function fetchScoreData(url) {
        console.log("fetchScoreData", url);
        url = (url == null || url == undefined || url == "") ? scoreData.url : url
        url = (url == null || url == undefined || url == "") ? baseUrl : url

        fetch(url)
        .then((data) => {            
            return data.json()
        })
        .then((json) => {            
            console.log(json);
            const newScoreData = {
                tasksData : json,
                url: url
            }
            setScoreData(newScoreData);
            setTasksData(json);
        });
    }

    function deleteScoreData(k) {
        console.log("deleteScoreData", k);
        const url = `${baseUrl}/${k}`

        fetch(url, {
            method: "DELETE"
        })
        .then((data) => {     
            fetchScoreData()       
            return data.json()            
        })
        
    }

	useEffect(() => {
        const url = localStorage.getItem('apiURL') ? localStorage.getItem('apiURL') : "/api/score"; //"/api/score"		
        fetchScoreData();
	}, []);

	const scoreDataResource = useMemo(() => {
		return { scoreData, fetchScoreData, deleteScoreData };
	}, [scoreData]);

	return html`
<${ScoreDataContext.Provider} value=${scoreDataResource}>
<div class="card">
    <div class="card-image">  
        <${StatusBage} todaysScore=${tasksData.total_starts_at} totalScore=${tasksData.total_points} />
    </div>
    <div class="card-header">
        <${FilterForm} />
    </div>
    <div class="card-body">
        <$${TasksLog} tasks=${tasksData.data}/>
    </div>
    <div class="card-footer">
        <${AddTaskForm} />
    </div>       
</div>
</ScoreDataContext.Provider>
`;
}
render(h(App), document.getElementById('app'));
</script>
</body>

</html>